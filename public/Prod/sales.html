<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font family to the entire body */
        body {
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease-in-out;
        }
        /* Sidebar transition for smooth hide/show */
        .sidebar {
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        /* Class to hide the sidebar completely */
        .sidebar-hidden {
            width: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            overflow: hidden;
        }
        /* Main content area transition */
        .main-content {
            transition: all 0.3s ease-in-out;
            flex: 1;
            overflow-y: auto;
        }
        /* Page content container for consistent padding and max-width */
        .page-content {
            width: 100%;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
            padding: 2rem;
        }
        /* Overlay for access denied message */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .overlay-content {
            background: white;
            padding: 3rem;
            border-radius: 1rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            color: #333;
        }
    </style>
    <!-- Client-side check for authentication token presence (kept as requested, without imports) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const accessToken = localStorage.getItem('supabase.auth.token'); 
            const firebaseCustomToken = localStorage.getItem('firebase.custom.token');

            if (!accessToken && !firebaseCustomToken) {
                window.location.href = '/login.html';
            }
        });
    </script>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden">

    <!-- Sidebar container, will be populated dynamically by sidebar-loader.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content Area - This is where the dashboard content will reside -->
    <div id="main-content" class="main-content flex flex-col">
        <!-- Main content is now inside this container which is centered by default -->
        <div class="page-content flex-grow">
            <!-- Header with Sidebar Toggle, Title, and Sign Out Button -->
            <header class="flex items-center justify-between mb-8 p-4 bg-white rounded-xl shadow-md">
                <!-- Sidebar Toggle Button -->
                <button id="sidebar-toggle-btn" class="p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105">
                    <svg id="toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <!-- Main Page Title -->
                <h1 id="main-title" class="text-3xl font-extrabold text-gray-800 tracking-tight">Sales Dashboard</h1>
                
                <!-- Sign Out Button -->
                <button id="signOutBtn" class="flex items-center space-x-2 py-2 px-4 rounded-full bg-red-600 text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200 ease-in-out transform hover:scale-105 shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    <span>Sign Out</span>
                </button>
            </header>
            
            <!-- Sales Metrics Section -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-2">Key Sales Metrics</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Metric Card 1: Total Revenue -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">Total Revenue</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-75" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.592 1L21 6m-2 5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <p class="text-4xl font-extrabold">$25,345.00</p>
                        <p class="text-sm opacity-90 mt-1">+12.5% from last month</p>
                    </div>

                    <!-- Metric Card 2: New Customers -->
                    <div class="bg-gradient-to-br from-green-500 to-teal-600 p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">New Customers</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-75" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14v2m-2 4h4m-4-8H6a2 2 0 00-2 2v4a2 2 0 002 2h6a2 2 0 002-2v-4a2 2 0 00-2-2z" />
                            </svg>
                        </div>
                        <p class="text-4xl font-extrabold">1,240</p>
                        <p class="text-sm opacity-90 mt-1">+8.2% from last month</p>
                    </div>

                    <!-- Metric Card 3: Conversion Rate -->
                    <div class="bg-gradient-to-br from-orange-500 to-red-600 p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">Conversion Rate</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-75" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                            </svg>
                        </div>
                        <p class="text-4xl font-extrabold">4.7%</p>
                        <p class="text-sm opacity-90 mt-1">+0.5% point from last month</p>
                    </div>

                    <!-- Metric Card 4: Average Order Value -->
                    <div class="bg-gradient-to-br from-blue-500 to-cyan-600 p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition-all duration-300">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-lg font-semibold">Avg. Order Value</h3>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 opacity-75" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </div>
                        <p class="text-4xl font-extrabold">$204.50</p>
                        <p class="text-sm opacity-90 mt-1">-3.1% from last month</p>
                    </div>
                </div>
            </section>

            <!-- Online Tracking Content - Retained from original, enhanced styling -->
            <section class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-2">Track In-Progress Items</h2>
                <div id="online-tracking-page" class="page bg-white p-6 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Current Online Tracking Queue</h3>
                    <p class="text-gray-600 leading-relaxed">
                        This section provides a real-time overview of all items currently in the online tracking queue.
                        You can view their current status, monitor progress, and access detailed information.
                        Use the filters below to refine your view or click on an item for more actions.
                    </p>
                    <!-- Placeholder for future tracking data/table -->
                    <div class="mt-6 p-4 border border-gray-300 rounded-lg bg-gray-50 text-gray-500 italic">
                        No tracking data available yet. Add items to the queue to see updates here.
                    </div>
                </div>
            </section>

            <!-- Drive Folder Integration Section -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b-2 border-indigo-200 pb-2">Cloud Storage & Collaboration</h2>
                <div class="bg-gradient-to-br from-teal-500 to-emerald-600 p-6 rounded-2xl shadow-xl text-white transform hover:scale-105 transition-all duration-300 border border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">Access Your Drive Folder</h3>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 opacity-75" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <p class="text-gray-100 leading-relaxed mb-6">
                        Seamlessly access your important documents and collaborative files directly from your cloud storage.
                        Click the button below to open your connected drive folder in a new tab.
                    </p>
                    <button id="openDriveBtn" class="flex items-center space-x-3 py-3 px-6 rounded-full bg-white text-teal-700 font-semibold hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-75 transition duration-200 ease-in-out transform hover:scale-105 shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m7 0V5a2 2 0 012-2h2a2 2 0 012 2v4m-6 0h.01M17 16l-4-4-4 4-2 2" />
                        </svg>
                        <span>Open My Drive</span>
                    </button>
                </div>
            </section>

        </div>
    </div>

    <!-- Page-specific script -->
    <script type="module">
        // TEMPORARY: Log the __app_id to the console
        console.log("Canvas App ID:", typeof __app_id !== 'undefined' ? __app_id : 'default-app-id-not-found');

        // ==== CORRECT IMPORTS ====
        import { initializeFirebaseAndAuth, checkPageAccess, signOutUser, openDriveFolder, userId, userPermissions, isAdminUser } from '../js/auth-rbac.js';
        import { loadSidebar } from '../js/sidebar-loader.js'; 
        // =========================

        const PAGE_CATEGORY = 'sales'; 
        const DRIVE_URL = 'https://drive.google.com/drive/folders/1Ky3GK4c5Gn_7PNJgcbZAFrQQhhfyc3vi'; // Specific drive URL for this page

        // --- Utility Functions (if this page needs specific messages) ---
        function showMessage(type, message) {
            // Implement your showMessage function here, similar to dashboard.html
            const existingMessageBox = document.querySelector('.message-box');
            if (existingMessageBox) {
                existingMessageBox.remove();
            }
            const messageBox = document.createElement('div');
            messageBox.classList.add('message-box', 'fixed', 'top-4', 'right-4', 'p-4', 'rounded-lg', 'shadow-lg', 'text-white', 'z-50', 'flex', 'items-center', 'space-x-3');
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-gray-700');
            }
            messageBox.innerHTML = `<strong class="font-bold">${type === 'success' ? 'Success!' : 'Error!'}</strong><span class="block sm:inline">${message}</span><button class="ml-auto text-white opacity-75 hover:opacity-100" onclick="this.parentElement.remove()"><svg class="fill-current h-4 w-4" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.15a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.15 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg></button>`;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                if (messageBox.parentElement) {
                    messageBox.remove();
                }
            }, 3000);
        }


        // Placeholder for sales data loading (implement if needed)
        function loadSalesDashboardData() {
            console.log("Loading sales specific data for user:", userId);
            // Example: Fetch data from an API if this page had dynamic content
            // const authToken = getAuthToken(); // Assuming getAuthToken is defined if needed
            // fetch('/api/sales-data', { headers: { 'Authorization': authToken } })
            //     .then(response => response.json())
            //     .then(data => {
            //         console.log('Sales data:', data);
            //         // Render sales data here
            //     })
            //     .catch(error => console.error('Error fetching sales data:', error));
        }

        // --- Main execution flow ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase Auth and RBAC logic FIRST
            initializeFirebaseAndAuth();

            // Wait for authentication and permissions to be ready
            document.addEventListener('authReady', (event) => {
                const { userPermissions, isAdminUser } = event.detail;

                // 1. Check access for THIS page
                checkPageAccess(PAGE_CATEGORY);

                // 2. Load sidebar with permissions (this hides/shows nav links)
                loadSidebar(userPermissions, isAdminUser).then(() => {
                    // 3. Load page-specific data ONLY if access is granted (or if admin)
                    const accessDeniedOverlay = document.getElementById('accessDeniedOverlay');
                    if (!accessDeniedOverlay || accessDeniedOverlay.style.display !== 'flex') {
                       loadSalesDashboardData();
                    }
                }).catch(error => {
                    console.error("Failed to load sidebar and initialize Sales page:", error);
                });
            });


            // Attach event listener for Sign Out button
            const signOutButton = document.getElementById('signOutBtn');
            if (signOutButton) {
                signOutButton.addEventListener('click', signOutUser);
            }

            // Attach event listener for Open Drive button
            const openDriveButton = document.getElementById('openDriveBtn');
            if (openDriveButton) {
                openDriveButton.addEventListener('click', () => openDriveFolder(DRIVE_URL));
            }
        });
    </script>
</body>
</html>
